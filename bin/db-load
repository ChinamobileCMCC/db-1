#!/usr/bin/env sh

bin=$(dirname "$0")
. "${bin}/include/all"

shortname=${2}
snapshot=${3}
find_snapshot "${snapshot}"
connection_details="--defaults-extra-file=${connection_config}"
database=$(cat "${database_file}")
extract_sql="${bin}/drivers/${databasetype}/vendor/extract_sql/extract_sql.pl"

if [ "$#" -lt 3 ]; then
  echo "SYNTAX: db restore [server] <snapshot> [table_1] [table_2] [...] [table_n]"
  echo "Restores a snapshot, or part of a snapshot"
  exit 1
fi

if [ ! -f "${file}" ]; then
  echo "${colored_shortname}Could not restore snapshot ${COLOR_LIGHT_BLUE}${snapshot}${COLOR_NC} - snapshot does not exist"
  exit 1
fi

# include functions to restore full snapshot and to restore individual tables
. "${bin}/drivers/${databasetype}/connectors/${connectiontype}/restore"


if [ "$#" -gt 3 ]; then
  # restore individual tables
  shift 3
  for table in "$@"; do
    code=""

    restore_table "${table}"

    if [ "${code}" -eq 0 ]; then
      echo "${colored_shortname}Restored table ${COLOR_LIGHT_BLUE}${table}${COLOR_NC} from snapshot ${COLOR_LIGHT_BLUE}${snapshot}${COLOR_NC}"
    else
      echo "${colored_shortname}Could not restore table ${COLOR_LIGHT_BLUE}${table}${COLOR_NC} from snapshot ${COLOR_LIGHT_BLUE}${snapshot}${COLOR_NC}"
    fi

  done
  exit 1
else
  # restore full snapshot
  code=""

  restore_snapshot

  if [ "${code}" -eq 0 ]; then
    echo "${colored_shortname}Restored snapshot ${COLOR_LIGHT_BLUE}${snapshot}${COLOR_NC}"
    exit 0
  else
    echo "${colored_shortname}Could not restore snapshot ${COLOR_LIGHT_BLUE}${snapshot}${COLOR_NC}"
    exit ${code}
  fi
fi

