#!/usr/bin/env sh

bin=$(dirname "$0")
. "${bin}/include/all"

what="dumps"
if [ "$#" -ge 3 ]; then
  what="${3}"
fi

if [ "${3}" = "--help" ]; then
  echo "USAGE:"
  echo "    ${COLOR_LIGHT_BLUE}db list${COLOR_NC}"
  echo ""
  echo "Prints a list of recorded database dumps"
  exit 1
fi

for s in ${servers}
do
  echo "[${COLOR_YELLOW}${s}${COLOR_NC}]"

  dumps="${repository}/${s}/dumps"
  path_length=$(echo "${dumps}/" | wc -c)
  meta="${repository}/${s}/meta"

  find "${dumps}" -type f -print0 | xargs -0 ls -1t | sed -e 's/\.gz$//' | cut -c ${path_length}- | while read hash
  do
    echo "${COLOR_NC}${hash}${COLOR_NC}"

    if [ -f "${meta}/${hash}" ]; then
      unix_ts=$(cat "${meta}/${hash}" | head -n 1)
      human_ts=$(cat "${meta}/${hash}" | head -n 2 | tail -n 1)
      msg=$(cat "${meta}/${hash}" | tail -n 1)
      echo "    ${COLOR_LIGHT_BLUE}${human_ts}${COLOR_NC} ${COLOR_LIGHT_GRAY}${msg}${COLOR_NC} "
      echo ""
    fi
  done

  echo ""
done
