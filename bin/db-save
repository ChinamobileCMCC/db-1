#!/usr/bin/env sh

bin=$(dirname "$0")
. "${bin}/include/all"

if [ "${3}" = "--help" ]; then
  echo "SYNTAX: ${COLOR_LIGHT_BLUE}db snapshot [server shortname]${COLOR_NC}"
  echo "Makes a snapshot of the database at the provided database server"
  exit 1
fi

msg=${3}

shift 2

ts=$(date +%Y%m%d-%H%M%S)

if [ -z "${msg}" ]; then
  filename=${ts}
else
  filename=${ts}-${msg}
  shift
fi
file="${dumps}/${filename}.gz"

echo "${colored_shortname}"
"${bin}/drivers/${databasetype}/connectors/${connectiontype}/snapshot" "${project_root}" "${identifier}" "${file}" "$@"
code=$?

hash=$(gzcat "${file}" | grep -v "^--" | grep -v "^/\*" | grep -v "^$" | shasum -a 512224 | cut -d " " -f 1)
count=$(find "${dumps}" -type f 2>/dev/null | grep "${hash}" | wc -l | sed -e 's/^[[:space:]]*//')

if [ "${count}" -eq "0" ]; then
  if [ "${code}" -eq 1 ]; then
    echo "${COLOR_RED}Could not make snapshot of database.${COLOR_NC}"
  else
    mv "${file}" "${dumps}/${hash} ${filename}.gz"
    echo "${COLOR_GREEN}Successfully made snapshot of database.${COLOR_NC}"
  fi
else
  rm "${file}"
  echo "${COLOR_RED}Database not changed since last dump${COLOR_NC}, not making a new snapshot."
fi


