#!/bin/sh
trap ctrl_c INT

function ctrl_c()
{
  # Try to remove repository if this script is interrupted
  # Will silently fail if repository is not empty
  rmdir "${repository}" 2>/dev/null
  exit 1
}

bin=$(dirname $0)
source "${bin}/include/all"

if [ ! -d "${repository}" ]; then
  mkdir -p "${repository}"
fi

type="${3}"
if [[ -z "${type// }" ]]; then
  type="mysql"
else
  shift
fi
supported=$(ls -1d ${bin}/drivers/*/ | rev | cut -d '/' -f 2 | rev)

while true; do
  if [ "$#" -lt 3 ]; then

    echo "\n${COLOR_LIGHT_BLUE}Please provide the database type for this repository${COLOR_NC}"
    echo "Supported types: ${supported}\n"
    user_input "Database type" "" "${type}" 0
    type=${answer}

  fi

  if [ -d "${bin}/drivers/${type}" ]; then
    echo "${type}" > "${repository}/type"
    ${bin}/../db server add
    exit $?
  fi

done
