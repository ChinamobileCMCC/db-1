#!/bin/sh

bin=$(dirname $0)
source "${bin}/include/all"

if [ ! -d "${repository}" ]; then
  mkdir -p "${repository}"
fi

identifier="${2}"
host="${3}"
username="${4}"
password="${5}"
database="${6}"

write_config()
{
  _identifier=$1
  _config="${repository}/${_identifier}/config"
  _credentials="${_config}/credentials.cnf"
  _db_file="${_config}/database"
  _dumps="${repository}/${_identifier}/dumps"

  if [ ! -d "${_config}" ]; then
    mkdir -p "${_config}"
  fi

  if [ ! -d "${_dumps}" ]; then
    mkdir -p "${_dumps}"
  fi

  echo "[client]" > "${_credentials}"
  echo "user = ${username}" >> "${_credentials}"
  echo "password = ${password}" >> "${_credentials}"
  echo "host = ${host}" >> "${_credentials}"

  chmod 600 "${_credentials}"

  echo "${database}" > "${_db_file}"
  chmod 600 "${_db_file}"
}

delete_config()
{
  _identifier=$1
  _config="${repository}/${_identifier}/config"
  _credentials="${_config}/credentials.cnf"
  _db_file="${_config}/database"
  _dumps="${repository}/${_identifier}/dumps"

  rm "${_credentials}"
  rm "${_db_file}"
  rmdir "${_config}"
  rmdir "${_dumps}"
  rmdir "${repository}/${_identifier}"
}


if [ "$#" -ne 6 ]; then
  echo "Usage: db init (identifier) (hostname) (username) (password) (database)"
fi

while true; do
  if [ "$#" -ne 6 ]; then

    echo "\n${COLOR_LIGHT_BLUE}Please provide the connection details for the database${COLOR_NC}"
    user_input "Identifier" "Please provide a meaningful name to refer to this database, such as 'local', 'development', 'staging', ..." "local" 0
    identifier=${answer}

    user_input "Database host" "Please provide a database hostname" "127.0.0.1" 0
    host=${answer}

    user_input "Username" "Please provide a username" "root" 0
    username=${answer}

    user_input "Password" "Please provide the password for user '${username}'" "" 1
    password=${answer}

    user_input "Database" "Please provide the name of a database" "" 0
    database=${answer}
  else
    # remove host, user, password etc from command line arguments
    shift 5
  fi

  ts=$(date +%Y%m%d-%H%M%S)
  test="test-${ts}"
  write_config "${test}"
  testcredentials="${repository}/${test}/config/credentials.cnf"
  "${mysql}" --defaults-extra-file=${testcredentials} -e"quit" >/dev/null
  code="${?}"
  delete_config "${test}"

  if [ "${code}" -eq 1 ]; then
    echo "${COLOR_RED}Could not connect to database. Please try again.${COLOR_NC}"
    continue
  else
    echo "${COLOR_GREEN}Successfully connected to database. Writing config.${COLOR_NC}"
  fi

  write_config "${identifier}"
  exit 0
done
